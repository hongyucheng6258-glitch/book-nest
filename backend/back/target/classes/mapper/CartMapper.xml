<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.book.mapper.CartMapper">

    <!-- 结果集映射：数据库列→实体类字段 -->
    <resultMap id="CartResultMap" type="com.example.book.entity.Cart">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="book_id" property="bookId"/>
        <result column="quantity" property="quantity"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="expire_at" property="expireAt"/>
        <!-- 关联书籍信息 -->
        <association property="book" column="book_id" select="com.example.book.mapper.BookMapper.selectById"/>
    </resultMap>

    <!-- 根据用户ID查询购物车列表 -->
    <select id="selectByUserId" resultMap="CartResultMap">
        SELECT id, user_id, book_id, quantity, created_at, updated_at, expire_at
        FROM cart
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 根据用户ID获取未过期的购物车商品列表 -->
    <select id="selectValidByUserId" resultMap="CartResultMap">
        <![CDATA[
        SELECT id, user_id, book_id, quantity, created_at, updated_at, expire_at
        FROM cart
        WHERE user_id = #{userId} AND (expire_at IS NULL OR expire_at > datetime('now'))
        ORDER BY created_at DESC
        ]]>
    </select>

    <!-- 根据用户ID和书籍ID查询购物车项 -->
    <select id="selectByUserIdAndBookId" resultMap="CartResultMap">
        SELECT id, user_id, book_id, quantity, created_at, updated_at, expire_at
        FROM cart
        WHERE user_id = #{userId} AND book_id = #{bookId}
    </select>

    <!-- 插入购物车项 -->
    <insert id="insert">
        INSERT INTO cart (user_id, book_id, quantity, created_at, updated_at, expire_at)
        VALUES (#{userId}, #{bookId}, #{quantity}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, #{expireAt})
    </insert>

    <!-- 更新购物车项数量 -->
    <update id="updateQuantity">
        UPDATE cart
        SET quantity = #{quantity}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>
    
    <!-- 更新购物车商品过期时间 -->
    <update id="updateExpireTime">
        UPDATE cart
        SET expire_at = #{expireAt}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>
    
    <!-- 删除过期购物车商品 -->
    <delete id="deleteExpired">
        <![CDATA[
        DELETE FROM cart
        WHERE expire_at IS NOT NULL AND expire_at <= datetime('now')
        ]]>
    </delete>

    <!-- 删除购物车项 -->
    <delete id="deleteById">
        DELETE FROM cart
        WHERE id = #{id}
    </delete>

    <!-- 根据用户ID清空购物车 -->
    <delete id="deleteByUserId">
        DELETE FROM cart
        WHERE user_id = #{userId}
    </delete>

</mapper>