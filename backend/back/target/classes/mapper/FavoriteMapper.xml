<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.book.mapper.FavoriteMapper">

    <!-- 结果集映射：数据库列→实体类字段 -->
    <resultMap id="FavoriteResultMap" type="com.example.book.entity.Favorite">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="book_id" property="bookId"/>
        <result column="created_at" property="createdAt"/>
        <!-- 关联书籍信息 -->
        <association property="book" column="book_id" select="com.example.book.mapper.BookMapper.selectById"/>
    </resultMap>

    <!-- 根据用户ID查询收藏列表 -->
    <select id="selectByUserId" resultMap="FavoriteResultMap">
        SELECT id, user_id, book_id, created_at
        FROM favorite
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 根据用户ID和书籍ID查询收藏 -->
    <select id="selectByUserIdAndBookId" resultMap="FavoriteResultMap">
        SELECT id, user_id, book_id, created_at
        FROM favorite
        WHERE user_id = #{userId} AND book_id = #{bookId}
        LIMIT 1
    </select>

    <!-- 插入收藏 -->
    <insert id="insert">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
            SELECT last_insert_rowid()
        </selectKey>
        INSERT INTO favorite (user_id, book_id, created_at)
        VALUES (#{userId}, #{bookId}, CURRENT_TIMESTAMP)
    </insert>

    <!-- 根据用户ID和书籍ID删除收藏 -->
    <delete id="deleteByUserIdAndBookId">
        DELETE FROM favorite
        WHERE user_id = #{userId} AND book_id = #{bookId}
    </delete>

</mapper>